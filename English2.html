<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>è‹±æ–‡å­¸ç¿’ç¿»è­¯å·¥å…·</title>
  <style>
    body { font-family: "Microsoft JhengHei", Arial, sans-serif; padding: 20px; background: #f7f7f7; }
    h1 { color: #333; }
    textarea { width: 100%; height: 120px; margin: 8px 0; padding: 10px; font-size: 16px; }
    .btn-row { margin: 10px 0; }
    button { margin: 5px; padding: 8px 14px; border: none; border-radius: 6px; background: #0078d7; color: white; cursor: pointer; }
    button:hover { background: #005fa3; }
    .sentence { padding: 8px; margin: 5px 0; border-radius: 6px; }
    .sentence span.en { cursor: pointer; }
    .sentence span.en:hover { background: #e9f3ff; }
    .highlight { background: #ffe08c; }
    .cn { color: #444; margin-left: 15px; display: block; cursor: pointer; }
    .word-popup { margin-top: 20px; padding: 10px; border: 1px solid #ccc; background: #fff; border-radius: 6px; }
    .word-popup h3 { margin: 0 0 8px 0; }
    select { padding: 5px; margin-left: 10px; }
  </style>
</head>
<body>
  <h1>è‹±æ–‡ â†’ ä¸­æ–‡ å­¸ç¿’ç¿»è­¯å·¥å…·</h1>

  <label for="inputText">è¼¸å…¥è‹±æ–‡æ–‡ç« ï¼š</label>
  <textarea id="inputText" placeholder="è¼¸å…¥è‹±æ–‡æ®µè½ï¼Œä¾‹å¦‚ï¼š\nLearning English is fun. It helps us communicate with the world."></textarea>

  <div class="btn-row">
    <button onclick="translateText()">ç¿»è­¯ä¸¦é¡¯ç¤ºå°ç…§</button>
    <label>ä¸­æ–‡è®Šé«”ï¼š
      <select id="langChoice">
        <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
        <option value="zh-CN">ç°¡é«”ä¸­æ–‡</option>
      </select>
    </label>
  </div>

  <h2>å°ç…§çµæœï¼š</h2>
  <div id="outputArea"></div>

  <!-- å–®å­—æŸ¥è©¢å€ -->
  <div id="wordPopup" class="word-popup" style="display:none;">
    <h3>å–®å­—æŸ¥è©¢</h3>
    <p><b>è‹±æ–‡ï¼š</b> <span id="wordEn"></span>
      <button onclick="speakWord()">ğŸ”Š ç™¼éŸ³</button>
    </p>
    <p><b>ä¸­æ–‡ï¼š</b> <span id="wordCn"></span></p>
  </div>

  <script>
    // åˆ‡å¥ (ç°¡å–®ä»¥.?!åˆ†å‰²)
    function splitSentences(text) {
      return text.match(/[^.!?]+[.!?]?/g) || [];
    }

    // ç¿»è­¯ (Google API)
    async function translateSentence(sentence, targetLang) {
      const url = "https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=" + targetLang + "&dt=t&q=" + encodeURIComponent(sentence);
      const res = await fetch(url);
      const data = await res.json();
      return data[0].map(item => item[0]).join("");
    }

    // ç¿»è­¯æ–‡ç« 
    async function translateText() {
      const input = document.getElementById("inputText").value.trim();
      const outputArea = document.getElementById("outputArea");
      const langChoice = document.getElementById("langChoice").value;

      outputArea.innerHTML = "";
      document.getElementById("wordPopup").style.display = "none";

      if (!input) {
        alert("è«‹è¼¸å…¥è‹±æ–‡æ–‡å­—");
        return;
      }

      const sentences = splitSentences(input);
      for (let s of sentences) {
        const translated = await translateSentence(s, langChoice);

        const div = document.createElement("div");
        div.className = "sentence";

        // è‹±æ–‡é€å­—å»ºç«‹ span
        const words = s.trim().split(/\s+/);
        words.forEach((w, i) => {
          const wordSpan = document.createElement("span");
          wordSpan.textContent = w + " ";
          wordSpan.className = "en";
          wordSpan.onclick = () => lookupWord(w);
          div.appendChild(wordSpan);
        });

        // ä¸­æ–‡ç¿»è­¯
        const cnSpan = document.createElement("span");
        cnSpan.className = "cn";
        cnSpan.textContent = translated;
        cnSpan.onclick = () => speak(cnSpan, translated, langChoice);
        div.appendChild(cnSpan);

        outputArea.appendChild(div);
      }
    }

    // èªéŸ³æ’­æ”¾
    function speak(el, text, lang) {
      speechSynthesis.cancel();
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = lang;
      utter.onstart = () => {
        document.querySelectorAll(".highlight").forEach(e => e.classList.remove("highlight"));
        el.classList.add("highlight");
      };
      utter.onend = () => el.classList.remove("highlight");
      speechSynthesis.speak(utter);
    }

    // å–®å­—æŸ¥è©¢
    async function lookupWord(word) {
      const langChoice = document.getElementById("langChoice").value;
      const url = "https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=" + langChoice + "&dt=t&q=" + encodeURIComponent(word);
      const res = await fetch(url);
      const data = await res.json();
      const translated = data[0].map(item => item[0]).join("");

      document.getElementById("wordEn").textContent = word;
      document.getElementById("wordCn").textContent = translated;
      document.getElementById("wordPopup").style.display = "block";
    }

    // ç™¼éŸ³å–®å­—
    function speakWord() {
      const word = document.getElementById("wordEn").textContent;
      if (!word) return;
      const utter = new SpeechSynthesisUtterance(word);
      utter.lang = "en-US";
      speechSynthesis.speak(utter);
    }
  </script>
</body>
</html>
