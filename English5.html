<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>è‹±æ–‡å­¸ç¿’ç¿»è­¯å·¥å…· + ç”Ÿå­—æœ¬ + SRS + åŒ¯å‡º</title>
  <style>
    body { font-family: "Microsoft JhengHei", Arial, sans-serif; padding: 20px; background: #f7f7f7; }
    h1 { color: #333; }
    textarea { width: 100%; height: 120px; margin: 8px 0; padding: 10px; font-size: 16px; }
    .btn-row { margin: 10px 0; }
    button { margin: 5px; padding: 8px 14px; border: none; border-radius: 6px; background: #0078d7; color: white; cursor: pointer; }
    button:hover { background: #005fa3; }
    .sentence { padding: 8px; margin: 5px 0; border-radius: 6px; }
    .sentence span.en { cursor: pointer; }
    .sentence span.en:hover { background: #e9f3ff; }
    .highlight { background: #ffe08c; }
    .cn { color: #444; margin-left: 15px; display: block; cursor: pointer; }
    .word-popup, .review-popup { margin-top: 20px; padding: 10px; border: 1px solid #ccc; background: #fff; border-radius: 6px; }
    .word-popup h3, .review-popup h3 { margin: 0 0 8px 0; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    .hidden { color: #aaa; cursor: pointer; }
  </style>

  <!-- docx.js for Word export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.0.2/docx.umd.min.js"></script>
  <!-- SheetJS for Excel export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <h1>è‹±æ–‡ â†’ ä¸­æ–‡ å­¸ç¿’ç¿»è­¯å·¥å…·</h1>

  <label for="inputText">è¼¸å…¥è‹±æ–‡æ–‡ç« ï¼š</label>
  <textarea id="inputText" placeholder="è¼¸å…¥è‹±æ–‡æ®µè½"></textarea>

  <div class="btn-row">
    <button onclick="translateText()">ç¿»è­¯ä¸¦é¡¯ç¤ºå°ç…§</button>
    <label>ä¸­æ–‡è®Šé«”ï¼š
      <select id="langChoice">
        <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
        <option value="zh-CN">ç°¡é«”ä¸­æ–‡</option>
      </select>
    </label>
  </div>

  <h2>å°ç…§çµæœï¼š</h2>
  <div class="btn-row">
    <button onclick="exportWord()">åŒ¯å‡º Word</button>
    <button onclick="exportExcel()">åŒ¯å‡º Excel</button>
  </div>
  <div id="outputArea"></div>

  <!-- å–®å­—æŸ¥è©¢å€ -->
  <div id="wordPopup" class="word-popup" style="display:none;">
    <h3>å–®å­—æŸ¥è©¢</h3>
    <p><b>è‹±æ–‡ï¼š</b> <span id="wordEn"></span>
      <button onclick="speakWord()">ğŸ”Š ç™¼éŸ³</button>
      <button onclick="addToNotebook()">â• åŠ å…¥ç”Ÿå­—æœ¬</button>
    </p>
    <p><b>ä¸­æ–‡ï¼š</b> <span id="wordCn"></span></p>
  </div>

  <!-- ç”Ÿå­—æœ¬ -->
  <h2>ğŸ“˜ ç”Ÿå­—æœ¬</h2>
  <div class="btn-row">
    <button onclick="exportNotebook()">åŒ¯å‡º JSON</button>
    <input type="file" id="importFile" onchange="importNotebook(event)" style="display:none;">
    <button onclick="document.getElementById('importFile').click()">åŒ¯å…¥ JSON</button>
    <button onclick="startReview()">é–‹å§‹è¤‡ç¿’</button>
  </div>
  <table id="notebookTable">
    <thead>
      <tr><th>è‹±æ–‡</th><th>ä¸­æ–‡</th><th>ä¸‹æ¬¡è¤‡ç¿’</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- è¤‡ç¿’æ¨¡å¼ -->
  <div id="reviewPopup" class="review-popup" style="display:none;">
    <h3>ğŸ”„ ç”Ÿå­—è¤‡ç¿’</h3>
    <p><b>è‹±æ–‡ï¼š</b> <span id="reviewWordEn"></span>
      <button onclick="speakReview()">ğŸ”Š</button>
    </p>
    <p><b>ä¸­æ–‡ï¼š</b> <span id="reviewWordCn" class="hidden" onclick="this.classList.remove('hidden')">é»æ“Šé¡¯ç¤ºç¿»è­¯</span></p>
    <div class="btn-row">
      <button onclick="markKnown()">âœ” æˆ‘æœƒäº†</button>
      <button onclick="markUnknown()">âœ˜ é‚„ä¸æœƒ</button>
      <button onclick="nextReview()">ä¸‹ä¸€é¡Œ</button>
      <button onclick="endReview()">çµæŸè¤‡ç¿’</button>
    </div>
  </div>

  <script>
    let notebook = [];
    let currentWord = "";
    let currentCn = "";
    let reviewList = [];
    let currentReview = null;

    // åˆ‡å¥
    function splitSentences(text) {
      return text.match(/[^.!?]+[.!?]?/g) || [];
    }

    // ç¿»è­¯
    async function translateSentence(sentence, targetLang) {
      const url = "https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=" + targetLang + "&dt=t&q=" + encodeURIComponent(sentence);
      const res = await fetch(url);
      const data = await res.json();
      return data[0].map(item => item[0]).join("");
    }

    async function translateText() {
      const input = document.getElementById("inputText").value.trim();
      const outputArea = document.getElementById("outputArea");
      const langChoice = document.getElementById("langChoice").value;
      outputArea.innerHTML = "";
      document.getElementById("wordPopup").style.display = "none";
      if (!input) { alert("è«‹è¼¸å…¥è‹±æ–‡æ–‡å­—"); return; }

      const sentences = splitSentences(input);
      for (let s of sentences) {
        const translated = await translateSentence(s, langChoice);
        const div = document.createElement("div");
        div.className = "sentence";

        const words = s.trim().split(/\s+/);
        words.forEach((w) => {
          const wordSpan = document.createElement("span");
          wordSpan.textContent = w + " ";
          wordSpan.className = "en";
          wordSpan.onclick = () => lookupWord(w);
          div.appendChild(wordSpan);
        });

        const cnSpan = document.createElement("span");
        cnSpan.className = "cn";
        cnSpan.textContent = translated;
        div.appendChild(cnSpan);

        outputArea.appendChild(div);
      }
    }

    // æŸ¥å–®å­—
    async function lookupWord(word) {
      const langChoice = document.getElementById("langChoice").value;
      const url = "https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=" + langChoice + "&dt=t&q=" + encodeURIComponent(word);
      const res = await fetch(url);
      const data = await res.json();
      const translated = data[0].map(item => item[0]).join("");

      currentWord = word;
      currentCn = translated;
      document.getElementById("wordEn").textContent = word;
      document.getElementById("wordCn").textContent = translated;
      document.getElementById("wordPopup").style.display = "block";
    }

    function speakWord() {
      if (!currentWord) return;
      const utter = new SpeechSynthesisUtterance(currentWord);
      utter.lang = "en-US";
      speechSynthesis.speak(utter);
    }

    // ç”Ÿå­—æœ¬
    function addToNotebook() {
      if (!currentWord || !currentCn) return;
      if (!notebook.some(w => w.en === currentWord)) {
        notebook.push({ en: currentWord, cn: currentCn, interval: 1, nextReview: todayString() });
        updateNotebookTable();
      }
    }

    function updateNotebookTable() {
      const tbody = document.querySelector("#notebookTable tbody");
      tbody.innerHTML = "";
      notebook.forEach(w => {
        const row = document.createElement("tr");
        row.innerHTML = `<td>${w.en}</td><td>${w.cn}</td><td>${w.nextReview}</td>`;
        tbody.appendChild(row);
      });
    }

    // åŒ¯å‡º JSON
    function exportNotebook() {
      const blob = new Blob([JSON.stringify(notebook, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "notebook.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    function importNotebook(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try {
          notebook = JSON.parse(e.target.result);
          updateNotebookTable();
        } catch {
          alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤");
        }
      };
      reader.readAsText(file);
    }

    // SRS è¤‡ç¿’
    function startReview() {
      const today = todayString();
      reviewList = notebook.filter(w => w.nextReview <= today);
      if (reviewList.length === 0) { alert("ä»Šå¤©æ²’æœ‰è¦è¤‡ç¿’çš„å–®å­—"); return; }
      document.getElementById("reviewPopup").style.display = "block";
      nextReview();
    }

    function nextReview() {
      if (reviewList.length === 0) {
        alert("ä»Šå¤©çš„è¤‡ç¿’å®Œæˆï¼");
        endReview();
        return;
      }
      currentReview = reviewList.pop();
      document.getElementById("reviewWordEn").textContent = currentReview.en;
      const cnSpan = document.getElementById("reviewWordCn");
      cnSpan.textContent = currentReview.cn;
      cnSpan.classList.add("hidden");
    }

    function markKnown() {
      if (!currentReview) return;
      currentReview.interval = Math.min(currentReview.interval * 2, 30);
      currentReview.nextReview = addDays(currentReview.interval);
      updateNotebookTable();
      nextReview();
    }

    function markUnknown() {
      if (!currentReview) return;
      currentReview.interval = 1;
      currentReview.nextReview = addDays(1);
      updateNotebookTable();
      nextReview();
    }

    function speakReview() {
      if (!currentReview) return;
      const utter = new SpeechSynthesisUtterance(currentReview.en);
      utter.lang = "en-US";
      speechSynthesis.speak(utter);
    }

    function endReview() {
      document.getElementById("reviewPopup").style.display = "none";
      currentReview = null;
    }

    // åŒ¯å‡º Word
    async function exportWord() {
      if (!document.querySelectorAll("#outputArea .sentence").length) {
        alert("è«‹å…ˆç¿»è­¯ä¸€æ®µæ–‡ç« ï¼");
        return;
      }
      const { Document, Packer, Paragraph, Table, TableCell, TableRow, WidthType, TextRun } = docx;
      let rows = [];
      document.querySelectorAll("#outputArea .sentence").forEach(div => {
        const enText = [...div.querySelectorAll("span.en")].map(s => s.textContent).join("").trim();
        const cnText = div.querySelector(".cn")?.textContent || "";
        rows.push(
          new TableRow({
            children: [
              new TableCell({
                children: [
                  new Paragraph({ children: [new TextRun({ text: enText, bold: true })] }),
                  new Paragraph({ children: [new TextRun({ text: cnText })] })
                ],
                width: { size: 70, type: WidthType.PERCENTAGE }
              }),
              new TableCell({
                children: [new Paragraph("")],
                width: { size: 30, type: WidthType.PERCENTAGE }
              })
            ]
          })
        );
      });
      const table = new Table({ rows: rows, width: { size: 100, type: WidthType.PERCENTAGE } });
      const doc = new Document({ sections: [{ properties: {}, children: [table] }] });
      const blob = await Packer.toBlob(doc);
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "ä¸­è‹±æ–‡å°ç…§.docx";
      a.click();
      URL.revokeObjectURL(url);
    }

    // åŒ¯å‡º Excel
    function exportExcel() {
      if (!document.querySelectorAll("#outputArea .sentence").length) {
        alert("è«‹å…ˆç¿»è­¯ä¸€æ®µæ–‡ç« ï¼");
        return;
      }
      let data = [["è‹±æ–‡ + ä¸­æ–‡", "ç©ºç™½"]];
      document.querySelectorAll("#outputArea .sentence").forEach(div => {
        const enText = [...div.querySelectorAll("span.en")].map(s => s.textContent).join("").trim();
        const cnText = div.querySelector(".cn")?.textContent || "";
        data.push([enText + "\n" + cnText, ""]);
      });
      let ws = XLSX.utils.aoa_to_sheet(data);
      let wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "ä¸­è‹±æ–‡å°ç…§");
      XLSX.writeFile(wb, "ä¸­è‹±æ–‡å°ç…§.xlsx");
    }

    // æ—¥æœŸå·¥å…·
    function todayString() {
      return new Date().toISOString().split("T")[0];
    }
    function addDays(n) {
      const d = new Date();
      d.setDate(d.getDate() + n);
      return d.toISOString().split("T")[0];
    }
  </script>
</body>
</html>
